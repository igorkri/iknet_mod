(function(){var e={};e.debug=true;e.system={};e.system.initMagicMethods=function(k,h){if(h===undefined){h=true}this.model=undefined;this.error=false;if(k===undefined){throw new TypeError("No argument")}if(h===true){var f=new e.system.rpcQueryModel();f.action="getXMLModel";f["class"]=k;var j=e.system.readData(f)}var i=new e.system.rpcQueryModel();i.action="getAjaxMethods";i["class"]=k;var g=e.system.readData(i);if(h===true){this.objPromise=$.when(j,g)}else{this.objPromise=$.when(g)}e[k]=new Object();e[k].objPromise=this.objPromise;this.objPromise.fail(function(){delete (e[k])});if(h===true){this.objPromise.done(function(l,p){try{var n=new Object;var m=$.parseXML(l[0]);$.each($(m).children("class").children("fields").children("var"),function(q,r){n[$(r).attr("name")]=new Object();$.each(this.attributes,function(){if(this.specified){if(this.name==="data-type"&&this.value==="JSON"){n[$(r).attr("name")]["json"]=new Object();$(m).children("class").children("json").children($(r).attr("name")).children("var").each(function(){var s=new Object();$.each(this.attributes,function(){if(this.specified){s[this.name]=this.value}});n[$(r).attr("name")]["json"][$(this).attr("name")]=s})}else{n[$(r).attr("name")][this.name]=this.value}}})});e[k].model=n;$.each($.parseJSON(p[0]),function(q,r){e[k][r]=function(t){if(t instanceof FormData){t.append("action","standardMethod");t.append("class",k);t.append("method",r);promiseObj=e.system.readData(t,false)}else{var s=new e.system.rpcQueryModel();s["class"]=k;s.method=r;s.arguments=t;promiseObj=e.system.readData(s)}return promiseObj}})}catch(o){e.system.printDbgMsg(o);alert("Incorrect data from server received");delete (e[k])}})}else{this.objPromise.done(function(l){try{$.each($.parseJSON(l),function(n,o){e[k][o]=function(q){var p=new e.system.rpcQueryModel();p["class"]=k;p.method=o;p.arguments=q;promiseObj=e.system.readData(p);return promiseObj}})}catch(m){e.system.printDbgMsg(m);alert("Incorrect data from server received");delete (e[k])}})}return this.objPromise};e.system.readData=function(i,j){if(j===undefined){j=true}var f=false;if(NProgress!==undefined){f=true}var h={url:"/ajax/",type:"POST",data:i,beforeSend:function(){if(f){NProgress.start()}},xhr:function(){var k=new window.XMLHttpRequest();k.upload.addEventListener("progress",function(l){if(l.lengthComputable){var m=l.loaded/l.total;if(f){NProgress.set(m/2)}}},false);k.addEventListener("progress",function(l){if(l.lengthComputable){var m=l.loaded/l.total;if(f){NProgress.set(m)}}},false);return k},complete:function(){if(f){NProgress.done()}}};if(j===false){h.processData=false;h.contentType=false}var g=$.ajax(h);g.fail(function(k){if(k.status===400){alert("Во время обработки данных на сервере проиошла ошибка.\n            "+k.responseText+"            Попробуйте обновить страницу и попробовать ещё раз.")}else{if(k.status===500){alert("Внутрення ошибка сервера.\n            "+k.responseText)}else{alert("Неизвестная ошибка.\n            "+k.responseText+" - "+k.status+"\n"+k.statusText)}}});return g};e.system.rpcQueryModel=function(){this.action="standardMethod";this["class"]="";this.method="";this.arguments=""};e.system.printDbgMsg=function(f){if("debug" in e===false||e.debug===undefined){return}if(f instanceof Error){console.log("Exception thrown:\n"+f.name+" : "+f.message+"\n")}else{console.log("Debug Msg:\n"+f+"\n")}};e.system.setLocalization=function(f){if(typeof f=="string"&&"cookie" in $){$.cookie("local",f,{path:"/"})}};e.system.removeLocalization=function(){if("removeCookie" in $){$.removeCookie("local",{path:"/"})}};e.parseFormData=function(f,g){return e.tools.parseFormData(f,g)};e.validateForm=function(g,h,f){return e.tools.validateForm(g,h,f)};e.tools={};e.tools.truncateString=function(h,f,g){if(f===undefined){f=7}if(g===undefined){g="..."}if(typeof h==="string"){if(h.length>f){h=h.substring(0,f);h=h+g}}return h};e.tools.appendIsnamonly=function(){$('input[data-isnamonly="true"]').each(function(f,g){$(this).keydown(function(h){if($.inArray(h.keyCode,[46,8,9,27,13,110,190])!==-1||(h.keyCode==65&&h.ctrlKey===true)||(h.keyCode>=35&&h.keyCode<=39)){return}if((h.shiftKey||(h.keyCode<48||h.keyCode>57))&&(h.keyCode<96||h.keyCode>105)){h.preventDefault()}})})};e.tools.getUrlParameter=function(f){var j=decodeURIComponent(window.location.search.substring(1)),h=j.split("&"),k,g;for(g=0;g<h.length;g++){k=h[g].split("=");if(k[0]===f){return k[1]===undefined?true:k[1]}}};e.tools.nl2br=function(h,g){var f=(g||typeof g==="undefined")?"<br />":"<br>";return(h+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+f+"$2")};e.tools.isDataUrl=function(f){if(typeof f=="string"){re=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return re.test(f)}else{return false}};e.tools.dataURItoBlob=function(g){var k;if(g.split(",")[0].indexOf("base64")>=0){k=atob(g.split(",")[1])}else{k=unescape(g.split(",")[1])}var f=g.split(",")[0].split(":")[1].split(";")[0];var h=new Uint8Array(k.length);for(var j=0;j<k.length;j++){h[j]=k.charCodeAt(j)}return new Blob([h],{type:f})};e.tools.validateForm=function(i,l,h){var g=e[i].model;var k=$("#"+l);if(h===undefined){h=false}var j=function(n,q){elementError=false;if(n.regexp!==undefined){var p=/\/((?![*+?])(?:[^\r\n\[/\\]|\\.|\[(?:[^\r\n\]\\]|\\.)*\])+)\/((?:g(?:im?|m)?|i(?:gm?|m)?|m(?:gi?|i)?)?)/;var m=p.exec(n.regexp);if(m!==null){var o=new RegExp(m[1],m[2]);if(o.test(q)===false){elementError=true}}}if(n["min-lenght"]!==undefined){if(q.length<n["min-lenght"]){elementError=true}}if(n["max-lenght"]!==undefined){if(q.length>n["max-lenght"]){elementError=true}}if(n["min-value"]!==undefined){if(q<n["min-value"]){elementError=true}}if(n["max-value"]!==undefined){if(q>n["max-value"]){elementError=true}}if(elementError===true){return false}else{return true}};var f=function(m){var n=false;jQuery.each(m,function(o,q){if(q.json!==null&&typeof q.json=="object"){if(f(q.json)===false){n=true}}var p;if(q.localization=="true"&&h===true){p=e.tools.validateForm.findLocalizedInputs(k,o)}else{p=k.find("#"+o)}$.each(p,function(t,s){var v=false;var r=$(s).attr("type");if(r=="text"||r=="textarea"){v=true}if(v){var w=$(s).val();var u=j(q,w);if(u){$(s).removeClass("error").addClass("success")}else{$(s).removeClass("success").addClass("error");n=true}}})});if(n===false){return true}else{return false}};return f(g)};e.tools.validateForm.findLocalizedInputs=function(i,j){var f=i.find("[id^="+j+"]");var h=new RegExp("^"+j+"_([a-zA-Z]{2})$");var g=[];$.each(f,function(k,l){var m=$(this).attr("id");if(h.test(m)===true){g.push(l)}});return g};e.tools.parseFormData=function(n,i){var k=false;var l=e[n].model;var f=$("#"+i);if(l===undefined){throw new Error("No Such Class")}if(f.length<1){throw new Error("No such form")}var h=function(r){var q=false;if(typeof CKEDITOR!=="undefined"){if(typeof CKEDITOR.instances[r]==="object"){q=true}}if(q===true){o=CKEDITOR.instances[r].getData();if(o.length>0){return o}else{return false}}var s=f.find("#"+r);var p=s.attr("type");if(p=="text"||p=="textarea"){if(s.length>0){var o=s.val();if(o.length>0){return o}}}else{if(p=="checkbox"){if(s.prop("checked")===true){return"1"}else{return"0"}}}return false};var m=function(o){var p={};jQuery.each(o,function(s,u){if(u.json!==null&&typeof u.json=="object"){jsonCallData=m(u.json);if(Object.keys(jsonCallData).length>0){p[s]=jsonCallData}}else{if(u.file!==undefined&&u.file=="true"){var t=$("#"+s);if(t.length>0){if(t.attr("type")=="file"){jQuery.each(t[0].files,function(z,y){j.append(s,y);k=true})}else{if(t.attr("type")=="text"){var x=t.val();if(e.tools.isDataUrl(x)){var r=e.tools.dataURItoBlob(x);var q=r.type.split("/");j.append(s,r,"canvasImage."+q[1]);k=true}}}}}else{var w=[];if(u.localization=="true"){var v=e.tools.validateForm.findLocalizedInputs(f,s);$.each(v,function(y,z){w.push($(z).attr("id"))})}else{w.push(s)}$.each(w,function(z,A){var y=h(A);if(y!==false){p[A]=y}})}}});return p};var j=new FormData();var g=m(l);if(k===true){g=JSON.stringify(g);j.append("arguments",g);return j}else{return g}};function a(g,f){return e.system.initMagicMethods(g,f)}function c(f,g){return e.system.readData(f,g)}function b(){return e.system.rpcQueryModel()}function d(f){e.system.printDbgMsg(f)}e.truncateString=function(h,f,g){return e.tools.truncateString(h,f,g)};e.init=e.system.initMagicMethods;window.EMA=e;window.ajaxObjectFactory=e.system.initMagicMethods;window.readData=e.system.readData;window.ajaxDataPort=e.system.rpcQueryModel;window.printDbgMsg=e.system.printDbgMsg})();